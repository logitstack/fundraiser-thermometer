<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fundraiser Control Panel</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .section-title {
            color: #667eea;
            font-weight: bold;
            font-size: 1.3em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        .input-row {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .input-row:last-child {
            margin-bottom: 0;
        }

        label {
            flex: 1;
            color: #333;
            font-weight: 600;
            font-size: 1em;
        }

        input[type="text"], input[type="number"], input[type="url"], select {
            width: 180px;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }

        input[type="text"]:focus, input[type="number"]:focus, input[type="url"]:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .wide-input {
            width: 280px !important;
        }

        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin-left: 10px;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .total {
            font-weight: bold;
            color: #667eea;
            margin-left: 15px;
            min-width: 100px;
            text-align: right;
            font-size: 1.1em;
        }

        #totalCollected {
            font-size: 20px;
            color: #27ae60;
            font-weight: bold;
        }

        .donation-section {
            grid-column: span 2;
        }

        .panels-section {
            grid-column: span 2;
        }

        .panel-config {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .panel-editor {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #667eea;
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .panel-title {
            font-weight: bold;
            color: #667eea;
            font-size: 1.1em;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #667eea;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .panel-items {
            display: none;
        }

        .panel-items.active {
            display: block;
        }

        .panel-item {
            display: flex;
            margin-bottom: 10px;
            gap: 10px;
        }

        .panel-item input {
            flex: 1;
            width: auto;
        }

        .add-item-btn {
            background: #27ae60;
            margin: 10px 0 0 0;
        }

        .remove-item-btn {
            background: #e74c3c;
            margin-left: 5px;
            padding: 8px 12px;
            font-size: 12px;
        }

        .status-bar {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-top: 20px;
            backdrop-filter: blur(10px);
        }

        .status-bar h3 {
            margin: 0 0 10px 0;
            color: #333;
        }

        .quick-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .quick-btn {
            background: #f39c12;
            margin: 0;
        }

        .preset-btn {
            background: #f39c12;
            margin: 0 5px 5px 0;
            padding: 6px 12px;
            font-size: 12px;
        }

        .preset-btn:hover {
            background: #e67e22;
        }

        input[type="color"] {
            width: 50px;
            height: 40px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            padding: 0;
        }

        input[type="range"] {
            width: 120px;
        }

        .auto-sync-status {
            color: #27ae60;
            font-size: 12px;
            font-weight: normal;
            margin-left: 15px;
            display: none;
        }

        .auto-sync-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #27ae60;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sync-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-left: 10px;
            font-size: 12px;
        }

        .sync-status .icon {
            width: 16px;
            height: 16px;
        }

        .sync-status.success { color: #27ae60; }
        .sync-status.error { color: #e74c3c; }
        .sync-status.syncing { color: #f39c12; }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .last-sync-info {
            font-size: 11px;
            color: #888;
            margin-top: 5px;
            text-align: right;
        }

        .reset-btn {
            background: #e74c3c !important;
            margin-left: 10px;
        }

        .reset-btn:hover {
            background: #c0392b !important;
        }

        .danger-zone {
            border-left-color: #e74c3c !important;
            background: #fdf2f2 !important;
        }

        .settings-btn {
            background: #9b59b6;
        }

        .settings-btn:hover {
            background: #8e44ad;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .donation-section, .panels-section {
                grid-column: span 1;
            }
            
            .panel-config {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Fundraiser Control Panel</h1>
            <p>Manage your thermometer display in real-time</p>
        </div>

        <div class="grid">
            <!-- Configuration Section -->
            <div class="section">
                <div class="section-title">‚öôÔ∏è Basic Configuration</div>
                <div class="input-row">
                    <label>Fundraiser Title:</label>
                    <input type="text" id="titleInput" placeholder="Enter title...">
                    <button onclick="setTitle()">Set Title</button>
                </div>
                <div class="input-row">
                    <label>Goal Amount:</label>
                    <input type="number" id="goalInput" min="0" step="0.01" placeholder="50000">
                    <button onclick="setGoal()">Set Goal</button>
                </div>
            </div>

            <!-- Totals Section -->
            <div class="section">
                <div class="section-title">üìä Current Status</div>
                <div class="input-row">
                    <label>Total Collected:</label>
                    <span id="totalCollected" class="total">$0</span>
                </div>
                <div class="input-row">
                    <label>Override Total:</label>
                    <input type="number" id="overrideTotal" step="0.01" placeholder="0.00">
                    <button onclick="applyOverride()">Apply</button>
                </div>
                <div class="input-row">
                    <label>Campaign URL:</label>
                    <input type="url" id="campaignUrl" class="wide-input" placeholder="https://fundraise.hhrd.org/...">
                    <button onclick="syncFromCampaign()" id="syncButton">Sync</button>
                    <button onclick="clearCampaignUrl()" class="reset-btn" id="clearUrlBtn" style="display: none;">Clear</button>
                </div>
                <div class="input-row">
                    <label>Auto-sync every minute:</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="autoSyncToggle" onchange="toggleAutoSync()">
                        <span class="slider"></span>
                    </label>
                    <span id="autoSyncStatus" class="auto-sync-status"></span>
                    <span id="syncStatus" class="sync-status"></span>
                </div>
                <div id="lastSyncInfo" class="last-sync-info" style="display: none;"></div>
            </div>

            <!-- Donation Inputs Section -->
            <div class="section donation-section">
                <div class="section-title" style="display: flex; justify-content: space-between; align-items: center;">
                    <span>üí∞ Donation Inputs</span>
                    <button class="reset-btn" onclick="resetDonationInputs()" style="font-size: 12px; padding: 8px 12px;">Reset All</button>
                </div>
                <div class="input-row">
                    <label>Cash:</label>
                    <input type="number" id="cashInput" step="0.01" placeholder="0.00">
                    <span id="cashTotal" class="total">$0.00</span>
                </div>
                <div class="input-row">
                    <label>Check:</label>
                    <input type="number" id="checkInput" step="0.01" placeholder="0.00">
                    <span id="checkTotal" class="total">$0.00</span>
                </div>
                <div class="input-row">
                    <label>Pledges:</label>
                    <input type="number" id="pledgesInput" step="0.01" placeholder="0.00">
                    <span id="pledgesTotal" class="total">$0.00</span>
                </div>
                <div class="input-row">
                    <label>Square:</label>
                    <input type="number" id="squareInput" step="0.01" placeholder="0.00">
                    <span id="squareTotal" class="total">$0.00</span>
                </div>
                <div class="input-row">
                    <label>Website:</label>
                    <input type="number" id="websiteInput" step="0.01" placeholder="0.00">
                    <span id="websiteTotal" class="total">$0.00</span>
                </div>
            </div>

            <!-- Info Panels Configuration -->
            <div class="section panels-section">
                <div class="section-title">üìã Information Panels</div>
                <p style="color: #666; margin-bottom: 20px;">Configure the information panels that appear beside your thermometer.</p>
                
                <div class="panel-config">
                    <!-- Left Panel -->
                    <div class="panel-editor">
                        <div class="panel-header">
                            <span class="panel-title">Left Panel</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="leftPanelToggle" onchange="togglePanel('left')">
                                <span class="slider"></span>
                            </label>
                        </div>
                        
                        <div class="panel-items" id="leftPanelItems">
                            <div class="input-row">
                                <label>Panel Title:</label>
                                <input type="text" id="leftPanelTitle" placeholder="Panel Title" oninput="savePanelData('left')">
                            </div>
                            <div id="leftPanelContent">
                                <!-- Dynamic items will be added here -->
                            </div>
                            <button class="add-item-btn" onclick="addPanelItem('left')">+ Add Item</button>
                        </div>
                    </div>

                    <!-- Right Panel -->
                    <div class="panel-editor">
                        <div class="panel-header">
                            <span class="panel-title">Right Panel</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="rightPanelToggle" onchange="togglePanel('right')">
                                <span class="slider"></span>
                            </label>
                        </div>
                        
                        <div class="panel-items" id="rightPanelItems">
                            <div class="input-row">
                                <label>Panel Title:</label>
                                <input type="text" id="rightPanelTitle" placeholder="Panel Title" oninput="savePanelData('right')">
                            </div>
                            <div id="rightPanelContent">
                                <!-- Dynamic items will be added here -->
                            </div>
                            <button class="add-item-btn" onclick="addPanelItem('right')">+ Add Item</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Customization Section -->
            <div class="section panels-section">
                <div class="section-title">üé® Appearance Customization</div>
                <p style="color: #666; margin-bottom: 20px;">Customize the look and feel of your thermometer display.</p>
                
                <div class="panel-config">
                    <!-- Colors -->
                    <div class="panel-editor">
                        <div class="panel-header">
                            <span class="panel-title">Colors</span>
                        </div>
                        
                        <div class="input-row">
                            <label>Background Color:</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="color" id="backgroundColorPicker" value="#01243c">
                                <input type="text" id="backgroundColorHex" placeholder="#01243c" style="width: 100px;" maxlength="7">
                            </div>
                        </div>
                        
                        <div class="input-row">
                            <label>Thermometer Fill:</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="color" id="fillColorPicker" value="#8ddbf5">
                                <input type="text" id="fillColorHex" placeholder="#8ddbf5" style="width: 100px;" maxlength="7">
                            </div>
                        </div>
                        
                        <div class="input-row">
                            <label>Title Color:</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="color" id="titleColorPicker" value="#efab3a">
                                <input type="text" id="titleColorHex" placeholder="#efab3a" style="width: 100px;" maxlength="7">
                            </div>
                        </div>
                    </div>

                    <!-- Typography & Position -->
                    <div class="panel-editor">
                        <div class="panel-header">
                            <span class="panel-title">Typography & Position</span>
                        </div>
                        
                        <div class="input-row">
                            <label>Title Font:</label>
                            <select id="titleFontSelect" style="width: 200px;">
                                <option value="Dancing Script">Dancing Script (Default)</option>
                                <option value="Anton">Anton (Bold)</option>
                                <option value="Moontime">Moontime (Decorative)</option>
                                <option value="Georgia">Georgia (Classic)</option>
                                <option value="Times New Roman">Times New Roman</option>
                                <option value="Arial">Arial (Clean)</option>
                                <option value="Helvetica">Helvetica</option>
                                <option value="Impact">Impact (Bold)</option>
                                <option value="Trebuchet MS">Trebuchet MS</option>
                                <option value="Verdana">Verdana</option>
                                <option value="Comic Sans MS">Comic Sans MS (Fun)</option>
                                <option value="Courier New">Courier New (Mono)</option>
                            </select>
                        </div>
                        
                        <div class="input-row">
                            <label>Title Size:</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="range" id="titleSizeSlider" min="20" max="80" value="45" oninput="updateSliderValue('titleSize')">
                                <span id="titleSizeValue" style="font-weight: bold; width: 40px;">45px</span>
                            </div>
                        </div>

                        <div class="input-row">
                            <label>Title Distance:</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="range" id="titleDistanceSlider" min="20" max="200" value="80" oninput="updateSliderValue('titleDistance')">
                                <span id="titleDistanceValue" style="font-weight: bold; width: 50px;">80px</span>
                            </div>
                        </div>

                        <div class="input-row">
                            <label style="margin-bottom: 0;">Quick Presets:</label>
                        </div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px;">
                            <button class="preset-btn" onclick="applyPreset('modern')">Modern</button>
                            <button class="preset-btn" onclick="applyPreset('classic')">Classic</button>
                            <button class="preset-btn" onclick="applyPreset('fun')">Fun</button>
                            <button class="preset-btn" onclick="applyPreset('corporate')">Corporate</button>
                            <button class="preset-btn" onclick="applyPreset('reset')">Reset</button>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 15px; text-align: center;">
                    <button style="background: #27ae60; margin: 0;" onclick="applyCustomization()">Apply All Changes</button>
                </div>
            </div>
        </div>

        <div class="status-bar">
            <h3>Quick Actions</h3>
            <div class="quick-actions">
                <button class="quick-btn" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
                <button class="quick-btn" onclick="exportData()">üì§ Export CSV</button>
                <button class="quick-btn settings-btn" onclick="exportSettings()">üíæ Export Settings</button>
                <button class="quick-btn settings-btn" onclick="importSettings()">üìÇ Import Settings</button>
                <button class="quick-btn" onclick="resetMilestones()">üéä Reset Milestones</button>
                <button class="quick-btn" onclick="window.open('ThermDisplayReal.html', '_blank')">üå°Ô∏è Open Display</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let categories = ['cash', 'check', 'pledges', 'square', 'website'];
        let totals = {};
        let panelItemCount = { left: 0, right: 0 };
        let transactions = []; // Store individual transactions

        // Auto-sync variables
        let autoSyncInterval = null;
        let autoSyncEnabled = false;
        let lastSyncTime = null;
        let syncRetryCount = 0;
        const MAX_SYNC_RETRIES = 3;

        // BroadcastChannel for instant updates between windows
        let broadcastChannel = null;
        try {
            broadcastChannel = new BroadcastChannel('fundraiser-updates');
        } catch (e) {
            console.log('BroadcastChannel not supported, falling back to localStorage polling');
        }

        // Broadcast update to other windows
        function broadcastUpdate(type, data) {
            if (broadcastChannel) {
                broadcastChannel.postMessage({ type, data, timestamp: Date.now() });
            }
        }

        // Load transactions from localStorage
        function loadTransactions() {
            const savedTransactions = localStorage.getItem('transactions');
            if (savedTransactions) {
                try {
                    transactions = JSON.parse(savedTransactions);
                } catch (e) {
                    console.error('Error loading transactions:', e);
                    transactions = [];
                }
            }
        }

        // Save transactions to localStorage
        function saveTransactions() {
            localStorage.setItem('transactions', JSON.stringify(transactions));
        }

        // Add a transaction record
        function addTransaction(type, amount, timestamp = null) {
            if (!timestamp) {
                timestamp = new Date().toISOString();
            }
            transactions.push({
                type: type,
                amount: amount,
                timestamp: timestamp
            });
            saveTransactions();
        }

        // Format number as currency (rounded to nearest dollar)
        function formatCurrency(number) {
            return '$' + Math.round(number).toLocaleString();
        }

        // Update total display
        function updateTotal() {
            let total = Object.values(totals).reduce((a, b) => a + b, 0);
            let storedOverride = parseFloat(localStorage.getItem('fundraiserTotal'));
            
            if (storedOverride !== null && !isNaN(storedOverride)) {
                document.getElementById('totalCollected').textContent = formatCurrency(storedOverride);
            } else {
                document.getElementById('totalCollected').textContent = formatCurrency(total);
                localStorage.setItem('fundraiserTotal', total);
            }
        }

        // Basic configuration functions
        function setTitle() {
            let title = document.getElementById('titleInput').value.trim();
            if (title) {
                localStorage.setItem('fundraiserTitle', title);
                document.getElementById('titleInput').value = '';
                broadcastUpdate('title', { title: title });
                alert('Title updated!');
            }
        }

        function setGoal() {
            let goal = parseFloat(document.getElementById('goalInput').value) || 0;
            if (goal > 0) {
                localStorage.setItem('fundraiserGoal', goal);
                document.getElementById('goalInput').value = '';
                // Reset celebrated milestones when goal changes
                localStorage.removeItem('celebratedMilestones');
                broadcastUpdate('goal', { goal: goal });
                alert('Goal updated!');
            }
        }

        function applyOverride() {
            let override = parseFloat(document.getElementById('overrideTotal').value);
            if (!isNaN(override)) {
                // Record the override as a transaction
                const currentTotal = Object.values(totals).reduce((a, b) => a + b, 0);
                const difference = override - currentTotal;
                if (difference !== 0) {
                    addTransaction('override', difference);
                }

                localStorage.setItem('fundraiserTotal', override);
                document.getElementById('totalCollected').textContent = formatCurrency(override);
                document.getElementById('overrideTotal').value = '';

                // Broadcast update to display window
                broadcastUpdate('override', { total: override });

                alert('Total overridden to ' + formatCurrency(override) + '!');
            }
        }

        // Show subtle notification for auto-sync updates
        function showAutoSyncNotification(amount) {
            let notification = document.getElementById('autoSyncNotification');
            if (!notification) {
                notification = document.createElement('div');
                notification.id = 'autoSyncNotification';
                notification.className = 'auto-sync-notification';
                document.body.appendChild(notification);
            }
            
            notification.textContent = `Website donations synced: ${formatCurrency(amount)}`;
            notification.style.opacity = '1';
            
            setTimeout(() => {
                notification.style.opacity = '0';
            }, 3000);
        }

        // Show auto-sync status message
        function showAutoSyncStatus(message) {
            const statusElement = document.getElementById('autoSyncStatus');
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.style.display = 'inline';
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 3000);
            }
        }

        // Update sync status indicator
        function updateSyncStatus(status, message = '') {
            const statusEl = document.getElementById('syncStatus');
            const lastSyncEl = document.getElementById('lastSyncInfo');

            if (!statusEl) return;

            switch(status) {
                case 'syncing':
                    statusEl.className = 'sync-status syncing';
                    statusEl.innerHTML = '<div class="spinner"></div> Syncing...';
                    break;
                case 'success':
                    statusEl.className = 'sync-status success';
                    statusEl.innerHTML = '‚úì Synced';
                    lastSyncTime = new Date();
                    localStorage.setItem('lastSyncTime', lastSyncTime.toISOString());
                    syncRetryCount = 0;
                    updateLastSyncDisplay();
                    setTimeout(() => { statusEl.innerHTML = ''; }, 3000);
                    break;
                case 'error':
                    statusEl.className = 'sync-status error';
                    statusEl.innerHTML = '‚úó ' + (message || 'Failed');
                    setTimeout(() => { statusEl.innerHTML = ''; }, 5000);
                    break;
                default:
                    statusEl.innerHTML = '';
            }
        }

        // Update last sync time display
        function updateLastSyncDisplay() {
            const lastSyncEl = document.getElementById('lastSyncInfo');
            if (!lastSyncEl || !lastSyncTime) return;

            const now = new Date();
            const diffMs = now - lastSyncTime;
            const diffMins = Math.floor(diffMs / 60000);

            let timeText;
            if (diffMins < 1) {
                timeText = 'just now';
            } else if (diffMins === 1) {
                timeText = '1 minute ago';
            } else if (diffMins < 60) {
                timeText = `${diffMins} minutes ago`;
            } else {
                const diffHours = Math.floor(diffMins / 60);
                timeText = diffHours === 1 ? '1 hour ago' : `${diffHours} hours ago`;
            }

            lastSyncEl.textContent = `Last synced: ${timeText}`;
            lastSyncEl.style.display = 'block';
        }

        // Reset all donation inputs to zero
        function resetDonationInputs() {
            if (!confirm('Are you sure you want to reset all donation totals to $0? This will clear Cash, Check, Pledges, Square, and Website totals. Transaction history will be preserved.')) {
                return;
            }

            // Record the reset as a transaction
            const currentTotal = Object.values(totals).reduce((a, b) => a + b, 0);
            if (currentTotal > 0) {
                addTransaction('reset', -currentTotal);
            }

            // Reset all category totals
            categories.forEach(category => {
                totals[category] = 0;
                document.getElementById(`${category}Total`).textContent = formatCurrency(0);
                localStorage.setItem(`${category}Total`, 0);
            });

            // Update the main total
            localStorage.setItem('fundraiserTotal', 0);
            updateTotal();

            // Broadcast the reset
            broadcastUpdate('reset', { total: 0 });

            alert('All donation totals have been reset to $0.');
        }

        // Export all settings (for backup)
        function exportSettings() {
            const settings = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                fundraiserTitle: localStorage.getItem('fundraiserTitle'),
                fundraiserGoal: localStorage.getItem('fundraiserGoal'),
                campaignUrl: localStorage.getItem('campaignUrl'),
                thermometerCustomization: localStorage.getItem('thermometerCustomization'),
                leftPanel: localStorage.getItem('leftPanel'),
                rightPanel: localStorage.getItem('rightPanel'),
                categoryTotals: {},
                transactions: transactions
            };

            categories.forEach(cat => {
                settings.categoryTotals[cat] = localStorage.getItem(`${cat}Total`);
            });

            const blob = new Blob([JSON.stringify(settings, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);

            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            link.download = `fundraiser-settings-${dateStr}.json`;
            link.click();

            alert('Settings exported successfully!');
        }

        // Import settings from backup
        function importSettings() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const settings = JSON.parse(e.target.result);

                        if (!settings.version) {
                            throw new Error('Invalid settings file format');
                        }

                        if (settings.fundraiserTitle) localStorage.setItem('fundraiserTitle', settings.fundraiserTitle);
                        if (settings.fundraiserGoal) localStorage.setItem('fundraiserGoal', settings.fundraiserGoal);
                        if (settings.campaignUrl) localStorage.setItem('campaignUrl', settings.campaignUrl);
                        if (settings.thermometerCustomization) localStorage.setItem('thermometerCustomization', settings.thermometerCustomization);
                        if (settings.leftPanel) localStorage.setItem('leftPanel', settings.leftPanel);
                        if (settings.rightPanel) localStorage.setItem('rightPanel', settings.rightPanel);

                        if (settings.categoryTotals) {
                            Object.keys(settings.categoryTotals).forEach(cat => {
                                if (settings.categoryTotals[cat]) {
                                    localStorage.setItem(`${cat}Total`, settings.categoryTotals[cat]);
                                }
                            });
                        }

                        if (settings.transactions && Array.isArray(settings.transactions)) {
                            transactions = settings.transactions;
                            saveTransactions();
                        }

                        alert('Settings imported successfully! Page will reload.');
                        location.reload();
                    } catch (error) {
                        alert('Error importing settings: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // Modified sync function - now updates Website donations instead of total
        async function syncFromCampaign(isAutoSync = false) {
            const campaignUrl = document.getElementById('campaignUrl').value.trim();
            if (!campaignUrl) {
                if (!isAutoSync) {
                    alert('Please enter a campaign URL');
                } else {
                    console.log('Auto-sync: No campaign URL found');
                }
                return;
            }

            if (!campaignUrl.toLowerCase().includes('fundraise.hhrd.org')) {
                if (!isAutoSync) {
                    alert('Please enter a valid HHRD fundraising URL');
                } else {
                    console.log('Auto-sync: Invalid HHRD URL');
                }
                return;
            }

            const syncButton = document.getElementById('syncButton');
            const originalText = syncButton.textContent;

            console.log(`${isAutoSync ? 'Auto-sync' : 'Manual sync'} starting for: ${campaignUrl}`);
            updateSyncStatus('syncing');

            try {
                if (!isAutoSync) {
                    syncButton.textContent = 'Syncing...';
                    syncButton.disabled = true;
                }

                // Try multiple CORS proxies in case one is down
                const proxies = [
                    `https://api.allorigins.win/raw?url=${encodeURIComponent(campaignUrl)}`,
                    `https://corsproxy.io/?${encodeURIComponent(campaignUrl)}`,
                    `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(campaignUrl)}`
                ];

                let html = null;
                let lastError = null;

                for (const proxyUrl of proxies) {
                    try {
                        console.log(`${isAutoSync ? 'Auto-sync' : 'Manual sync'} trying proxy:`, proxyUrl);
                        const response = await fetch(proxyUrl, { timeout: 10000 });

                        if (!response.ok) {
                            console.log(`Proxy returned HTTP ${response.status}, trying next...`);
                            continue;
                        }

                        html = await response.text();

                        // Check if we got actual HTML content (not an error page)
                        if (html && html.length > 500 && (html.includes('<!DOCTYPE') || html.includes('<html'))) {
                            console.log(`${isAutoSync ? 'Auto-sync' : 'Manual sync'} received HTML length:`, html.length);
                            break;
                        } else {
                            console.log('Proxy returned invalid/short response, trying next...');
                            html = null;
                        }
                    } catch (proxyError) {
                        console.log(`Proxy failed: ${proxyError.message}, trying next...`);
                        lastError = proxyError;
                    }
                }

                if (!html) {
                    throw new Error(lastError ? lastError.message : 'All proxies failed to fetch the campaign page');
                }
                
                const amount = extractHHRDAmount(html);
                console.log(`${isAutoSync ? 'Auto-sync' : 'Manual sync'} extracted amount:`, amount);

                if (amount !== null) {
                    const currentWebsiteAmount = totals['website'] || 0;
                    console.log(`${isAutoSync ? 'Auto-sync' : 'Manual sync'} current website amount:`, currentWebsiteAmount, 'new amount:', amount);
                    
                    if (amount !== currentWebsiteAmount) {
                        console.log(`${isAutoSync ? 'Auto-sync' : 'Manual sync'} updating website amount from ${currentWebsiteAmount} to ${amount}`);
                        
                        // Record the change as a transaction
                        const difference = amount - currentWebsiteAmount;
                        addTransaction('website', difference);
                        
                        // Update the website donation total directly in the totals object and display
                        totals['website'] = amount;
                        document.getElementById('websiteTotal').textContent = formatCurrency(amount);
                        localStorage.setItem('websiteTotal', amount);
                        localStorage.setItem('campaignUrl', campaignUrl);
                        document.getElementById('clearUrlBtn').style.display = 'inline-block';
                        
                        // Recalculate and update the overall total
                        let categoryTotal = Object.values(totals).reduce((a, b) => a + b, 0);
                        localStorage.setItem('fundraiserTotal', categoryTotal);
                        updateTotal();
                        
                        console.log(`${isAutoSync ? 'Auto-sync' : 'Manual sync'} new total:`, categoryTotal);
                        
                        // Broadcast the update to other windows
                        broadcastUpdate('donation', { total: categoryTotal, website: amount });

                        if (isAutoSync) {
                            showAutoSyncNotification(amount);
                        } else {
                            alert(`Successfully synced! Website donations updated to ${formatCurrency(amount)}`);
                        }
                    } else {
                        console.log(`${isAutoSync ? 'Auto-sync' : 'Manual sync'} no change in amount, skipping update`);
                        if (!isAutoSync) {
                            alert(`Sync successful! Amount is already up to date: ${formatCurrency(amount)}`);
                        }
                    }
                    updateSyncStatus('success');
                    syncRetryCount = 0;
                } else {
                    // Log sample of HTML to help debug
                    console.log('HTML sample (first 2000 chars):', html.substring(0, 2000));
                    throw new Error('Could not find donation amount on page. The page structure may have changed. Check browser console for details.');
                }

            } catch (error) {
                console.error(`${isAutoSync ? 'Auto-sync' : 'Manual sync'} error:`, error);
                updateSyncStatus('error', error.message.substring(0, 30));

                // Retry logic for auto-sync with exponential backoff
                if (isAutoSync && syncRetryCount < MAX_SYNC_RETRIES) {
                    syncRetryCount++;
                    const retryDelay = Math.pow(2, syncRetryCount) * 30000; // 30s, 60s, 120s
                    console.log(`Auto-sync will retry in ${retryDelay/1000} seconds (attempt ${syncRetryCount}/${MAX_SYNC_RETRIES})`);
                    setTimeout(() => syncFromCampaign(true), retryDelay);
                }

                if (!isAutoSync) {
                    alert('Sync failed: ' + error.message + '\n\nOpen browser console (F12) for more details.');
                }
            } finally {
                if (!isAutoSync) {
                    syncButton.textContent = originalText;
                    syncButton.disabled = false;
                }
            }
        }

        // Clear campaign URL and stop auto-sync
        function clearCampaignUrl() {
            if (!confirm('Clear the campaign URL? This will stop auto-sync and hide the QR code on the display.')) {
                return;
            }

            // Stop auto-sync if running
            if (autoSyncInterval) {
                clearInterval(autoSyncInterval);
                autoSyncInterval = null;
            }
            autoSyncEnabled = false;
            document.getElementById('autoSyncToggle').checked = false;

            // Clear the URL
            document.getElementById('campaignUrl').value = '';
            localStorage.removeItem('campaignUrl');
            localStorage.removeItem('autoSyncEnabled');
            localStorage.removeItem('lastSyncTime');

            // Hide the clear button and last sync info
            document.getElementById('clearUrlBtn').style.display = 'none';
            document.getElementById('lastSyncInfo').style.display = 'none';
            document.getElementById('syncStatus').innerHTML = '';

            // Broadcast to hide QR code
            broadcastUpdate('clearUrl', {});

            showAutoSyncStatus('Campaign URL cleared');
        }

        // Toggle auto-sync
        function toggleAutoSync() {
            const campaignUrl = document.getElementById('campaignUrl').value.trim();
            if (!campaignUrl) {
                alert('Please enter a campaign URL first');
                document.getElementById('autoSyncToggle').checked = false;
                return;
            }

            autoSyncEnabled = document.getElementById('autoSyncToggle').checked;
            
            if (autoSyncEnabled) {
                autoSyncInterval = setInterval(() => {
                    syncFromCampaign(true);
                }, 60000);
                
                syncFromCampaign(true);
                showAutoSyncStatus('Auto-sync enabled - syncing every minute');
            } else {
                if (autoSyncInterval) {
                    clearInterval(autoSyncInterval);
                    autoSyncInterval = null;
                }
                showAutoSyncStatus('Auto-sync disabled');
            }
            
            localStorage.setItem('autoSyncEnabled', autoSyncEnabled);
        }

        // Load auto-sync preference on page load
        function loadAutoSyncPreference() {
            const saved = localStorage.getItem('autoSyncEnabled');
            const campaignUrl = localStorage.getItem('campaignUrl');
            
            if (saved === 'true' && campaignUrl) {
                document.getElementById('autoSyncToggle').checked = true;
                autoSyncEnabled = true;
                
                autoSyncInterval = setInterval(() => {
                    syncFromCampaign(true);
                }, 60000);
                
                showAutoSyncStatus('Auto-sync restored - syncing every minute');
            }
        }

        // Enhanced HTML parsing for both HHRD page formats
        function extractHHRDAmount(html) {
            try {
                // Method 1 (BEST): Extract from embedded JSON data
                // HHRD pages embed campaign data as JSON with fields like "totalRaisedAmount" or "raisedAmount"
                const jsonPatterns = [
                    /"totalRaisedAmount"\s*:\s*([\d.]+)/,
                    /"raisedAmount"\s*:\s*([\d.]+)/,
                    /"raised_amount"\s*:\s*([\d.]+)/,
                    /"amountRaised"\s*:\s*([\d.]+)/,
                    /"total_raised"\s*:\s*([\d.]+)/,
                    /"currentAmount"\s*:\s*([\d.]+)/
                ];

                for (const pattern of jsonPatterns) {
                    const match = html.match(pattern);
                    if (match) {
                        const amount = parseFloat(match[1]);
                        if (!isNaN(amount) && amount >= 0) {
                            console.log('Found amount using Method 1 (JSON data):', amount);
                            return amount;
                        }
                    }
                }

                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');

                // Method 2: Look for "$X,XXX.XX raised" in primary bold text
                const primaryBoldElements = doc.querySelectorAll('.text-primary.font-bold, .font-bold.text-primary');
                for (const element of primaryBoldElements) {
                    const text = element.textContent || element.innerText;
                    if (text && text.includes('raised')) {
                        const match = text.match(/\$([0-9,]+\.?[0-9]*)/);
                        if (match) {
                            const amount = parseFloat(match[1].replace(/,/g, ''));
                            if (!isNaN(amount) && amount > 0) {
                                console.log('Found amount using Method 2 (text-primary font-bold):', amount);
                                return amount;
                            }
                        }
                    }
                }

                // Method 3: Common HHRD selectors
                const commonSelectors = [
                    '.donation-amount',
                    '.raised-amount',
                    '.current-amount',
                    '.amount-raised',
                    '.total-raised',
                    '.progress-amount',
                    '#raised-amount',
                    '.fund-amount',
                    '.collected'
                ];

                for (const selector of commonSelectors) {
                    const element = doc.querySelector(selector);
                    if (element) {
                        const text = element.textContent || element.innerText;
                        const amount = parseAmountText(text);
                        if (amount !== null && amount > 0) {
                            console.log(`Found amount using Method 3 (${selector}):`, amount);
                            return amount;
                        }
                    }
                }

                // Method 4: Look for any element containing "raised" with dollar amounts
                const allElements = doc.querySelectorAll('*');
                for (const element of allElements) {
                    const text = element.textContent || element.innerText;
                    if (text && text.includes('raised') && text.includes('$')) {
                        const match = text.match(/\$([0-9,]+\.?[0-9]*)\s*raised/i);
                        if (match) {
                            const amount = parseFloat(match[1].replace(/,/g, ''));
                            if (!isNaN(amount) && amount > 0) {
                                console.log('Found amount using Method 4 (text contains "raised"):', amount);
                                return amount;
                            }
                        }
                    }
                }

                // Method 5: Search for potential amount elements
                const potentialAmountElements = doc.querySelectorAll('[class*="text-"], [class*="font-"], span, div');
                for (const element of potentialAmountElements) {
                    const text = element.textContent || element.innerText;
                    if (text && text.includes('$') && (text.includes('raised') || text.includes('of'))) {
                        const amount = parseAmountText(text);
                        if (amount !== null && amount > 0) {
                            console.log('Found amount using Method 5 (potential amount elements):', amount);
                            return amount;
                        }
                    }
                }

                // Method 6: Fallback - scan entire body for dollar amounts
                const bodyText = doc.body ? doc.body.textContent : html;
                const dollarMatches = bodyText.match(/\$[\d,]+(?:\.\d{2})?/g);

                if (dollarMatches && dollarMatches.length > 0) {
                    const amounts = dollarMatches
                        .map(match => parseAmountText(match))
                        .filter(amt => amt !== null && amt > 0 && amt < 10000000)
                        .sort((a, b) => b - a);

                    if (amounts.length > 0) {
                        console.log('Found amount using Method 6 (body text scan):', amounts[0]);
                        console.log('All amounts found:', amounts);
                        return amounts[0];
                    }
                }

                console.log('No donation amount found in HTML');
                return null;
            } catch (error) {
                console.error('Error parsing HTML:', error);
                return null;
            }
        }

        function parseAmountText(text) {
            if (!text) return null;
            const cleaned = text.replace(/[^0-9,\.]/g, '');
            const number = parseFloat(cleaned.replace(/,/g, ''));
            return isNaN(number) ? null : number;
        }

        // Panel management functions
        function togglePanel(side) {
            const isChecked = document.getElementById(`${side}PanelToggle`).checked;
            const panelItems = document.getElementById(`${side}PanelItems`);
            
            if (isChecked) {
                panelItems.classList.add('active');
            } else {
                panelItems.classList.remove('active');
            }
            savePanelData(side);
        }

        function addPanelItem(side) {
            const count = ++panelItemCount[side];
            const itemHtml = `
                <div class="panel-item" data-item="${count}">
                    <input type="text" placeholder="Label" class="item-label" oninput="savePanelData('${side}')">
                    <input type="text" placeholder="Value" class="item-value" oninput="savePanelData('${side}')">
                    <button class="remove-item-btn" onclick="removePanelItem('${side}', ${count})">√ó</button>
                </div>
            `;
            document.getElementById(`${side}PanelContent`).insertAdjacentHTML('beforeend', itemHtml);
        }

        function removePanelItem(side, itemId) {
            const item = document.querySelector(`#${side}PanelContent .panel-item[data-item="${itemId}"]`);
            if (item) {
                item.remove();
                savePanelData(side);
            }
        }

        function savePanelData(side) {
            const isActive = document.getElementById(`${side}PanelToggle`).checked;
            const title = document.getElementById(`${side}PanelTitle`).value;
            const items = [];
            
            document.querySelectorAll(`#${side}PanelContent .panel-item`).forEach(item => {
                const label = item.querySelector('.item-label').value;
                const value = item.querySelector('.item-value').value;
                if (label && value) {
                    items.push({ label, value });
                }
            });

            const panelData = { active: isActive, title, items };
            localStorage.setItem(`${side}Panel`, JSON.stringify(panelData));
        }

        function loadPanelData() {
            ['left', 'right'].forEach(side => {
                const data = localStorage.getItem(`${side}Panel`);
                if (data) {
                    const panelData = JSON.parse(data);
                    document.getElementById(`${side}PanelToggle`).checked = panelData.active;
                    document.getElementById(`${side}PanelTitle`).value = panelData.title || '';
                    
                    if (panelData.active) {
                        document.getElementById(`${side}PanelItems`).classList.add('active');
                    }
                    
                    panelData.items.forEach(item => {
                        addPanelItem(side);
                        const items = document.querySelectorAll(`#${side}PanelContent .panel-item`);
                        const lastItem = items[items.length - 1];
                        lastItem.querySelector('.item-label').value = item.label;
                        lastItem.querySelector('.item-value').value = item.value;
                    });
                }
            });
        }

        // Customization functions
        function updateSliderValue(type) {
            const slider = document.getElementById(`${type}Slider`);
            const display = document.getElementById(`${type}Value`);
            display.textContent = slider.value + 'px';
        }

        function syncColorPickers() {
            document.getElementById('backgroundColorPicker').addEventListener('input', function() {
                document.getElementById('backgroundColorHex').value = this.value;
            });
            
            document.getElementById('backgroundColorHex').addEventListener('input', function() {
                const hex = this.value;
                if (hex.match(/^#[0-9A-F]{6}$/i)) {
                    document.getElementById('backgroundColorPicker').value = hex;
                }
            });
            
            document.getElementById('fillColorPicker').addEventListener('input', function() {
                document.getElementById('fillColorHex').value = this.value;
            });
            
            document.getElementById('fillColorHex').addEventListener('input', function() {
                const hex = this.value;
                if (hex.match(/^#[0-9A-F]{6}$/i)) {
                    document.getElementById('fillColorPicker').value = hex;
                }
            });
            
            document.getElementById('titleColorPicker').addEventListener('input', function() {
                document.getElementById('titleColorHex').value = this.value;
            });
            
            document.getElementById('titleColorHex').addEventListener('input', function() {
                const hex = this.value;
                if (hex.match(/^#[0-9A-F]{6}$/i)) {
                    document.getElementById('titleColorPicker').value = hex;
                }
            });
        }

        function applyCustomization() {
            const customization = {
                backgroundColor: document.getElementById('backgroundColorPicker').value,
                fillColor: document.getElementById('fillColorPicker').value,
                titleColor: document.getElementById('titleColorPicker').value,
                titleFont: document.getElementById('titleFontSelect').value,
                titleSize: document.getElementById('titleSizeSlider').value,
                titleDistance: document.getElementById('titleDistanceSlider').value
            };

            localStorage.setItem('thermometerCustomization', JSON.stringify(customization));
            broadcastUpdate('customization', customization);
            alert('Customization applied! Changes will appear on the thermometer display.');
        }

        function loadCustomization() {
            const saved = localStorage.getItem('thermometerCustomization');
            if (saved) {
                const customization = JSON.parse(saved);
                document.getElementById('backgroundColorPicker').value = customization.backgroundColor || '#01243c';
                document.getElementById('backgroundColorHex').value = customization.backgroundColor || '#01243c';
                document.getElementById('fillColorPicker').value = customization.fillColor || '#8ddbf5';
                document.getElementById('fillColorHex').value = customization.fillColor || '#8ddbf5';
                document.getElementById('titleColorPicker').value = customization.titleColor || '#efab3a';
                document.getElementById('titleColorHex').value = customization.titleColor || '#efab3a';
                document.getElementById('titleFontSelect').value = customization.titleFont || 'Dancing Script';
                document.getElementById('titleSizeSlider').value = customization.titleSize || 45;
                document.getElementById('titleSizeValue').textContent = (customization.titleSize || 45) + 'px';
                document.getElementById('titleDistanceSlider').value = customization.titleDistance || 80;
                document.getElementById('titleDistanceValue').textContent = (customization.titleDistance || 80) + 'px';
            }
        }

        function applyPreset(preset) {
            let settings = {};
            
            switch(preset) {
                case 'modern':
                    settings = {
                        backgroundColor: '#1a1a2e',
                        fillColor: '#00d4ff',
                        titleColor: '#ffffff',
                        titleFont: 'Arial',
                        titleSize: 48,
                        titleDistance: 80
                    };
                    break;
                case 'classic':
                    settings = {
                        backgroundColor: '#2c3e50',
                        fillColor: '#3498db',
                        titleColor: '#f39c12',
                        titleFont: 'Georgia',
                        titleSize: 42,
                        titleDistance: 80
                    };
                    break;
                case 'fun':
                    settings = {
                        backgroundColor: '#8e44ad',
                        fillColor: '#f1c40f',
                        titleColor: '#e74c3c',
                        titleFont: 'Comic Sans MS',
                        titleSize: 50,
                        titleDistance: 80
                    };
                    break;
                case 'corporate':
                    settings = {
                        backgroundColor: '#34495e',
                        fillColor: '#16a085',
                        titleColor: '#ecf0f1',
                        titleFont: 'Helvetica',
                        titleSize: 40,
                        titleDistance: 80
                    };
                    break;
                case 'reset':
                    settings = {
                        backgroundColor: '#01243c',
                        fillColor: '#8ddbf5',
                        titleColor: '#efab3a',
                        titleFont: 'Dancing Script',
                        titleSize: 45,
                        titleDistance: 80
                    };
                    break;
            }
            
            document.getElementById('backgroundColorPicker').value = settings.backgroundColor;
            document.getElementById('backgroundColorHex').value = settings.backgroundColor;
            document.getElementById('fillColorPicker').value = settings.fillColor;
            document.getElementById('fillColorHex').value = settings.fillColor;
            document.getElementById('titleColorPicker').value = settings.titleColor;
            document.getElementById('titleColorHex').value = settings.titleColor;
            document.getElementById('titleFontSelect').value = settings.titleFont;
            document.getElementById('titleSizeSlider').value = settings.titleSize;
            document.getElementById('titleSizeValue').textContent = settings.titleSize + 'px';
            document.getElementById('titleDistanceSlider').value = settings.titleDistance;
            document.getElementById('titleDistanceValue').textContent = settings.titleDistance + 'px';
            
            applyCustomization();
        }

        // Quick actions
        function clearAllData() {
            if (confirm('Are you sure you want to clear all data? This cannot be undone.')) {
                localStorage.clear();
                transactions = [];
                location.reload();
            }
        }

        // Reset milestone celebrations (for testing)
        function resetMilestones() {
            localStorage.removeItem('celebratedMilestones');
            broadcastUpdate('resetMilestones', {});
            alert('Milestone celebrations have been reset. They will trigger again when thresholds are crossed.');
        }

        // Fixed export data function - now exports CSV of transactions
        function exportData() {
            if (transactions.length === 0) {
                alert('No transaction data to export. Add some donations first!');
                return;
            }

            // Create CSV header
            let csvContent = 'Type,Amount,Timestamp\n';
            
            // Add each transaction
            transactions.forEach(transaction => {
                const date = new Date(transaction.timestamp).toLocaleString();
                csvContent += `${transaction.type},${transaction.amount},"${date}"\n`;
            });

            // Create and download the CSV file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            
            // Generate filename with current date
            const now = new Date();
            const dateStr = now.getFullYear() + '-' + 
                           String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                           String(now.getDate()).padStart(2, '0');
            link.setAttribute('download', `fundraiser-transactions-${dateStr}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`Exported ${transactions.length} transactions to CSV file!`);
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        Object.keys(data).forEach(key => {
                            localStorage.setItem(key, data[key]);
                        });
                        location.reload();
                    } catch (error) {
                        alert('Error importing data. Please check the file format.');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Load transactions first
            loadTransactions();
            
            categories.forEach(category => {
                totals[category] = parseFloat(localStorage.getItem(`${category}Total`)) || 0;
                document.getElementById(`${category}Total`).textContent = formatCurrency(totals[category]);
                
                document.getElementById(`${category}Input`).addEventListener('change', function() {
                    let value = parseFloat(this.value);
                    if (!isNaN(value) && value !== 0) {
                        // Record the transaction
                        addTransaction(category, value);

                        totals[category] += value;
                        document.getElementById(`${category}Total`).textContent = formatCurrency(totals[category]);
                        localStorage.setItem(`${category}Total`, totals[category]);
                        this.value = '';

                        let categoryTotal = Object.values(totals).reduce((a, b) => a + b, 0);
                        localStorage.setItem('fundraiserTotal', categoryTotal);
                        updateTotal();

                        // Broadcast update to display window
                        broadcastUpdate('donation', { total: categoryTotal, category: category, amount: value });
                    }
                });

                document.getElementById(`${category}Input`).addEventListener('keypress', function(e) {
                    if (e.which === 13) {
                        this.dispatchEvent(new Event('change'));
                    }
                });
            });

            updateTotal();
            loadPanelData();
            loadCustomization();
            syncColorPickers();
            loadAutoSyncPreference();

            // Load last sync time
            const savedLastSync = localStorage.getItem('lastSyncTime');
            if (savedLastSync) {
                lastSyncTime = new Date(savedLastSync);
                updateLastSyncDisplay();
            }

            // Update last sync display every minute
            setInterval(updateLastSyncDisplay, 60000);

            setInterval(updateTotal, 1000);

            const savedTitle = localStorage.getItem('fundraiserTitle');
            const savedGoal = localStorage.getItem('fundraiserGoal');
            const savedCampaignUrl = localStorage.getItem('campaignUrl');

            if (savedTitle) document.getElementById('titleInput').placeholder = `Current: ${savedTitle}`;
            if (savedGoal) document.getElementById('goalInput').placeholder = `Current: $${parseFloat(savedGoal).toLocaleString()}`;
            if (savedCampaignUrl) {
                document.getElementById('campaignUrl').value = savedCampaignUrl;
                document.getElementById('clearUrlBtn').style.display = 'inline-block';
            }
        });
    </script>
</body>
</html>
